WITH weekly as(
  SELECT a.id as acc,
    COUNT(t.id)as Weekly_Activity_Count
  FROM salesforce_fivetran.task t 
  JOIN salesforce_fivetran.account a on t.account_id = a.id
  WHERE date_trunc('day',t.created_date) > (current_date - 7)
  GROUP BY a.id
  ORDER BY Weekly_Activity_Count ASC
)

, monthly as(
  SELECT t.account_id as acc,COUNT(t.id) as Monthly_Activity_Count
  FROM salesforce_fivetran.task t 
  WHERE date_trunc('day',t.created_date) > (current_date - 30)
  GROUP BY t.account_id
)

, quarterly as(
  SELECT t.account_id as acc,COUNT(t.id) as Quarterly_Activity_Count
  FROM salesforce_fivetran.task t 
  WHERE date_trunc('day',t.created_date) > (current_date - 90)
  GROUP BY t.account_id
)

, usergems as(
  SELECT vw.sfdc_user_gems__c.user_gems_current_company__c as Comp_Name
  ,COUNT(vw.sfdc_user_gems__c.user_gems_current_company__c) as Usergem_Count
FROM vw.sfdc_user_gems__c
WHERE 
  vw.sfdc_user_gems__c.account_owner__c LIKE '%Enass%' 
  OR
  vw.sfdc_user_gems__c.account_owner__c LIKE '%Jenna%'
GROUP BY vw.sfdc_user_gems__c.user_gems_current_company__c
)

SELECT a.name,(current_date - date_trunc('day',a.last_target_account_date_c)) as Target_Time,
  CASE WHEN quarterly.Quarterly_Activity_Count IS NULL THEN 0 ELSE quarterly.Quarterly_Activity_Count   END AS Quarter,
  CASE WHEN monthly.Monthly_Activity_Count IS NULL THEN 0 ELSE monthly.Monthly_Activity_Count END AS Month,
  CASE WHEN weekly.Weekly_Activity_Count IS NULL THEN 0 ELSE weekly.Weekly_Activity_Count END AS Week
,CASE
  WHEN a.dfox_latest_funding_amount_c > 5000000
  THEN 1 ELSE 0 END 
  + 
  CASE
  WHEN a.dfox_latest_funding_date_c > '2018-01-01'
  THEN 1 ELSE 0 END 
  +
  CASE
  WHEN a.total_opp_count_c > 1
  THEN 2
  WHEN a.total_opp_count_c = 1
  THEN 1
  ELSE 0 END 
  +
  CASE
  WHEN usergems.Usergem_Count > 1
  THEN 2
  WHEN usergems.Usergem_Count = 1
  THEN 1
  ELSE 0 END
  AS Account__Quality_Index
FROM salesforce_fivetran.account a
LEFT JOIN salesforce_fivetran.task t on a.id = t.account_id
LEFT JOIN salesforce_fivetran.user u on u.id = t.created_by_id
LEFT JOIN weekly on weekly.acc = a.id
LEFT JOIN monthly on monthly.acc = a.id
LEFT JOIN quarterly on quarterly.acc = a.id
LEFT JOIN usergems on usergems.Usergem_Count = a.name
WHERE 
  a.account_status_c != 'Customer'
  AND a.adr_most_wanted_c = 't'
  AND a.opp_count_open_ops_c = 0
  AND (select id from salesforce_fivetran.user where [salesforce_fivetran.user.last_name=ADR_Last_Name]) = a.owner_id 
GROUP BY a.name,a.last_target_account_date_c,weekly.Weekly_Activity_Count,monthly.Monthly_Activity_Count,quarterly.Quarterly_Activity_Count,a.dfox_latest_funding_amount_c,a.dfox_latest_funding_date_c,a.total_opp_count_c,usergems.Usergem_Count
