WITH usergems as(
  SELECT vw.sfdc_user_gems__c.user_gems_current_company__c as Comp_Name
  ,COUNT(vw.sfdc_user_gems__c.user_gems_current_company__c) as Usergem_Count
FROM vw.sfdc_user_gems__c
WHERE 
  vw.sfdc_user_gems__c.account_owner__c LIKE '%Enass%' 
  OR
  vw.sfdc_user_gems__c.account_owner__c LIKE '%Jenna%'
GROUP BY vw.sfdc_user_gems__c.user_gems_current_company__c
)

SELECT a.name
,a.df_sub_industry_c
,a.dfox_latest_funding_date_c
,a.dfox_latest_funding_amount_c
,a.dfox_stage_c
,a.dfox_employees_c
,a.total_opp_count_c
,a.dfox_country_code_c
,CASE
  WHEN a.dfox_latest_funding_amount_c > 5000000
  THEN 1 ELSE 0 END 
  + 
  CASE
  WHEN a.dfox_latest_funding_date_c > '2018-01-01'
  THEN 1 ELSE 0 END 
  +
  CASE
  WHEN a.total_opp_count_c > 1
  THEN 2
  WHEN a.total_opp_count_c = 1
  THEN 1
  ELSE 0 END 
  +
  CASE
  WHEN usergems.Usergem_Count > 1
  THEN 2
  WHEN usergems.Usergem_Count = 1
  THEN 1
  ELSE 0 END 
  AS Account_Quality_Index
,usergems.Usergem_Count
FROM salesforce_fivetran.account a
JOIN salesforce_fivetran.user u on a.owner_id = u.id
FULL OUTER JOIN usergems on usergems.Comp_Name = a.name
WHERE a.adr_most_wanted_c = 'f'
  AND(
    (select id from salesforce_fivetran.user where [salesforce_fivetran.user.last_name=ADR_Last_Name]) = a.owner_id
  OR (select id from salesforce_fivetran.user where salesforce_fivetran.user.first_name = 'Jenna') = a.owner_id
  OR inactive_account_c = true
     )
  and df_sub_industry_c LIKE '%Software%'
  and df_sub_industry_c NOT LIKE '%security%'
  and dfox_employees_c < 200
  and dfox_stage_c NOT IN ('Public','Acquired','Subsidiary','Late Stage')
  AND dfox_country_code_c = 'US'
  AND type != 'Customer'
ORDER BY Account_Quality_Index DESC,a.total_opp_count_c DESC,a.dfox_latest_funding_date_c
