WITH daily as(
  SELECT a.id as acc,
    COUNT(t.id)as Daily_Activity_Count
  FROM salesforce_fivetran.task t 
  JOIN salesforce_fivetran.account a on t.account_id = a.id
  WHERE date_trunc('day',t.created_date) >= (current_date - 1)
  GROUP BY a.id
  ORDER BY Daily_Activity_Count ASC
)

SELECT a.name,(current_date - date_trunc('day',a.last_target_account_date_c)) as Target_Time,
  CAST(CASE WHEN daily.Daily_Activity_Count IS NULL THEN 0 ELSE daily.Daily_Activity_Count END AS integer) AS Daily
FROM salesforce_fivetran.account a
LEFT JOIN salesforce_fivetran.task t on a.id = t.account_id
LEFT JOIN salesforce_fivetran.user u on u.id = t.created_by_id
LEFT JOIN daily on daily.acc = a.id
WHERE 
  a.account_status_c != 'Customer'
  AND a.adr_most_wanted_c = 't'
  AND a.opp_count_open_ops_c = 0
  AND (select id from salesforce_fivetran.user where [salesforce_fivetran.user.last_name=ADR_Last_Name]) = a.owner_id 
GROUP BY a.name,a.last_target_account_date_c,daily.Daily_Activity_Count
ORDER BY Daily DESC
